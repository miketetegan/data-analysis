apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

nameSuffix: -prod

# No need to point to base for the Helm partâ€”define it here for clarity
helmCharts:
  - name: grafana
    releaseName: lhw-data-analysis
    repo: https://grafana.github.io/helm-charts
    version: 8.5.x
    namespace: monitoring-prod
    valuesFile: values-prod.yaml
    includeCRDs: true

patches:
  # PATCH 1: Update StorageClass to local-path
  - target:
      kind: PersistentVolumeClaim
      name: lhw-data-analysis
    patch: |-
      - op: replace
        path: /spec/storageClassName
        value: "local-path"

  # PATCH 2: Vault Injection + Command Override for Env Vars
  - target:
      kind: Deployment
      name: lhw-data-analysis
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: lhw-data-analysis
        annotations:
          vault.hashicorp.com/agent-inject: "true"
          vault.hashicorp.com/role: "grafana-prod-role"
          vault.hashicorp.com/agent-inject-status: "update"
          vault.hashicorp.com/agent-inject-secret-config.env: "secret/data/grafana/config"
          vault.hashicorp.com/agent-inject-template-config.env: |
            {{ with secret "secret/data/grafana/config" }}
            export GF_SECURITY_ADMIN_USER="{{ .Data.data.admin_user }}"
            export GF_SECURITY_ADMIN_PASSWORD="{{ .Data.data.admin_password }}"
            {{ end }}
      spec:
        template:
          spec:
            containers:
              - name: grafana
                command: ["/bin/sh", "-c"]
                args: 
                  - |
                    # Source the file created by Vault to load Envs
                    if [ -f /vault/secrets/config.env ]; then
                      source /vault/secrets/config.env
                    fi
                    /run.sh
