apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# The chart is adding 'grafana' to the name, so we match it
nameSuffix: -prod

helmCharts:
  - name: grafana
    releaseName: lhw-data-analysis
    repo: https://grafana.github.io/helm-charts
    version: 8.5.12
    namespace: monitoring-prod
    includeCRDs: true

patches:
  # 1. DELETE the Secret the chart is trying to use
  - target:
      kind: Secret
      name: lhw-data-analysis-grafana
    patch: |-
      $patch: delete
      apiVersion: v1
      kind: Secret
      metadata:
        name: lhw-data-analysis-grafana

  # 2. FIX THE DEPLOYMENT (Using the correct live name)
  - target:
      kind: Deployment
      name: lhw-data-analysis-grafana
    patch: |-
      # Remove the environment variables causing "secret not found"
      - op: remove
        path: /spec/template/spec/containers/0/env

      # REMOVE the LDAP volume and mount so the Pod can actually start
      - op: remove
        path: /spec/template/spec/containers/0/volumeMounts/1
      - op: remove
        path: /spec/template/spec/volumes/1

      # ADD Vault Annotations (This triggers the sidecar)
      - op: add
        path: /spec/template/metadata/annotations
        value:
          vault.hashicorp.com/agent-inject: "true"
          vault.hashicorp.com/role: "grafana-prod-role"
          # Admin Secrets
          vault.hashicorp.com/agent-inject-secret-config.env: "secret/data/grafana/config"
          vault.hashicorp.com/agent-inject-template-config.env: |
            {{ with secret "secret/data/grafana/config" }}
            export GF_SECURITY_ADMIN_USER="{{ .Data.data.admin_user }}"
            export GF_SECURITY_ADMIN_PASSWORD="{{ .Data.data.admin_password }}"
            {{ end }}
          # LDAP Secrets
          vault.hashicorp.com/agent-inject-secret-ldap.toml: "secret/data/grafana/ldap"
          vault.hashicorp.com/agent-inject-template-ldap.toml: |
            {{ with secret "secret/data/grafana/ldap" }}
            [[servers]]
            host = "{{ .Data.data.host }}"
            port = 389
            use_ssl = false
            bind_dn = "{{ .Data.data.bind_dn }}"
            bind_password = "{{ .Data.data.bind_password }}"
            search_filter = "(cn=%s)"
            search_base_dns = ["dc=example,dc=org"]
            [[servers.group_mappings]]
            group_dn = "cn=admins,dc=example,dc=org"
            org_role = "Admin"
            {{ end }}

      # FIX the entrypoint to source the Vault files
      - op: replace
        path: /spec/template/spec/containers/0/command
        value: ["/bin/sh", "-c"]
      - op: replace
        path: /spec/template/spec/containers/0/args
        value:
          - |
            if [ -f /vault/secrets/config.env ]; then
              source /vault/secrets/config.env
            fi
            # Tell Grafana to use the LDAP file from Vault
            export GF_AUTH_LDAP_ENABLED=true
            export GF_AUTH_LDAP_CONFIG_FILE=/vault/secrets/ldap.toml
            /run.sh
