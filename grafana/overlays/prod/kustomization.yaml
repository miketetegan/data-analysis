apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

nameSuffix: -prod

helmCharts:
  - name: grafana
    releaseName: lhw-data-analysis
    repo: https://grafana.github.io/helm-charts
    version: 8.5.12
    namespace: monitoring-prod
    valuesFile: values-prod.yaml
    includeCRDs: true

patches:
  # 1. DELETE the Secret
  - target:
      kind: Secret
      name: lhw-data-analysis
    patch: |-
      $patch: delete
      apiVersion: v1
      kind: Secret
      metadata:
        name: lhw-data-analysis

  # 2. Update StorageClass
  - target:
      kind: PersistentVolumeClaim
      name: lhw-data-analysis
    patch: |-
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: lhw-data-analysis
      spec:
        storageClassName: "local-path"

  # 3. The "Full Override" Deployment Patch
  - target:
      kind: Deployment
      name: lhw-data-analysis
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: lhw-data-analysis
        annotations:
          vault.hashicorp.com/agent-inject: "true"
          vault.hashicorp.com/role: "grafana-prod-role"
          vault.hashicorp.com/agent-inject-secret-config.env: "secret/data/grafana/config"
          vault.hashicorp.com/agent-inject-template-config.env: |
            {{ with secret "secret/data/grafana/config" }}
            export GF_SECURITY_ADMIN_USER="{{ .Data.data.admin_user }}"
            export GF_SECURITY_ADMIN_PASSWORD="{{ .Data.data.admin_password }}"
            {{ end }}
          vault.hashicorp.com/agent-inject-secret-ldap.toml: "secret/data/grafana/ldap"
          vault.hashicorp.com/agent-inject-template-ldap.toml: |
            {{ with secret "secret/data/grafana/ldap" }}
            [[servers]]
            host = "{{ .Data.data.host }}"
            port = 389
            use_ssl = false
            bind_dn = "{{ .Data.data.bind_dn }}"
            bind_password = "{{ .Data.data.bind_password }}"
            search_filter = "(cn=%s)"
            search_base_dns = ["dc=example,dc=org"]
            [[servers.group_mappings]]
            group_dn = "cn=admins,dc=example,dc=org"
            org_role = "Admin"
            {{ end }}
      spec:
        template:
          spec:
            # We tell Kustomize to replace the entire containers list
            containers:
              - name: grafana
                $patch: replace
                image: docker.io/grafana/grafana:11.3.0
                command: ["/bin/sh", "-c"]
                args:
                  - |
                    if [ -f /vault/secrets/config.env ]; then
                      source /vault/secrets/config.env
                    fi
                    /run.sh
                env:
                  - name: GF_PATHS_DATA
                    value: /var/lib/grafana/
                # ONLY include the mounts that EXIST in the volumes list below
                volumeMounts:
                  - mountPath: /etc/grafana/grafana.ini
                    name: config
                    subPath: grafana.ini
                  - mountPath: /var/lib/grafana
                    name: storage
                ports:
                  - containerPort: 3000
                    name: grafana
            # We tell Kustomize to replace the entire volumes list
            volumes:
              - $patch: replace
              - configMap:
                  name: lhw-data-analysis-prod
                name: config
              - name: storage
                persistentVolumeClaim:
                  claimName: lhw-data-analysis-prod
