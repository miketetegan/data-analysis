apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

nameSuffix: -prod

helmCharts:
  - name: grafana
    releaseName: lhw-data-analysis
    repo: https://grafana.github.io/helm-charts
    version: 8.5.x
    namespace: monitoring-prod
    includeCRDs: true
    valuesInline:
      fullnameOverride: lhw-data-analysis
      # Tricking the chart: Telling it we have an existing secret 
      # prevents it from auto-generating a new one.
      admin:
        existingSecret: "manual-vault-injection" 
      # Disable the chart's internal env var generation
      env:
        GF_SECURITY_ADMIN_USER: null
        GF_SECURITY_ADMIN_PASSWORD: null

# --- RESOURCE FILTERING ---
# This ensures that even if Helm renders a Secret, Kustomize discards it.
patches:
  - target:
      kind: Secret
      name: lhw-data-analysis
    patch: |-
      $patch: delete
      apiVersion: v1
      kind: Secret
      metadata:
        name: lhw-data-analysis

  # --- DEPLOYMENT CLEANUP & VAULT INJECTION ---
  - target:
      kind: Deployment
      name: lhw-data-analysis
    patch: |-
      # Remove the env block entirely to clear out the "secret not found" errors
      - op: remove
        path: /spec/template/spec/containers/0/env
      
      # Inject Vault Annotations into the Pod Template
      - op: add
        path: /spec/template/metadata/annotations
        value:
          vault.hashicorp.com/agent-inject: "true"
          vault.hashicorp.com/role: "grafana-prod-role"
          vault.hashicorp.com/agent-inject-secret-config.env: "secret/data/grafana/config"
          vault.hashicorp.com/agent-inject-template-config.env: |
            {{ with secret "secret/data/grafana/config" }}
            export GF_SECURITY_ADMIN_USER="{{ .Data.data.admin_user }}"
            export GF_SECURITY_ADMIN_PASSWORD="{{ .Data.data.admin_password }}"
            {{ end }}
      
      # Override Command to source Vault Envs
      - op: replace
        path: /spec/template/spec/containers/0/command
        value: ["/bin/sh", "-c"]
      - op: replace
        path: /spec/template/spec/containers/0/args
        value: 
          - |
            if [ -f /vault/secrets/config.env ]; then
              source /vault/secrets/config.env
            fi
            /run.sh
