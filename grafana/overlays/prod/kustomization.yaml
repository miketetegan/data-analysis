apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

nameSuffix: -prod

helmCharts:
  - name: grafana
    releaseName: lhw-data-analysis
    repo: https://grafana.github.io/helm-charts
    version: 8.5.x
    namespace: monitoring-prod
    valuesFile: values-prod.yaml
    includeCRDs: true

patches:
  # PATCH 1: Delete the Secret resource so it never exists in the cluster
  - target:
      kind: Secret
      name: lhw-data-analysis
    patch: |-
      $patch: delete
      apiVersion: v1
      kind: Secret
      metadata:
        name: lhw-data-analysis

  # PATCH 2: Ensure correct StorageClass
  - target:
      kind: PersistentVolumeClaim
      name: lhw-data-analysis
    patch: |-
      - op: replace
        path: /spec/storageClassName
        value: "local-path"

  # PATCH 3: The Deployment Cleanup and Vault Injection
  - target:
      kind: Deployment
      name: lhw-data-analysis
    patch: |-
      # A. Strip the auto-generated env vars (removes secretKeyRef: vault-only)
      - op: remove
        path: /spec/template/spec/containers/0/env

      # B. Strip the auto-generated Volume and Mount (fixes FailedMount error)
      # We use indices here. Usually, ldap is the 2nd mount and 3rd volume in this chart.
      # If these fail, we can target them via strategic merge in the next block.
      - op: remove
        path: /spec/template/spec/containers/0/volumeMounts/1
      - op: remove
        path: /spec/template/spec/volumes/2

      # C. Inject Vault Annotations
      # Note: '~1' is the escaped character for '/' in JSON patch keys
      - op: add
        path: /spec/template/metadata/annotations/vault.hashicorp.com~1agent-inject
        value: "true"
      - op: add
        path: /spec/template/metadata/annotations/vault.hashicorp.com~1role
        value: "grafana-prod-role"
      
      # Admin Credentials Template
      - op: add
        path: /spec/template/metadata/annotations/vault.hashicorp.com~1agent-inject-secret-config.env
        value: "secret/data/grafana/config"
      - op: add
        path: /spec/template/metadata/annotations/vault.hashicorp.com~1agent-inject-template-config.env
        value: |
          {{ with secret "secret/data/grafana/config" }}
          export GF_SECURITY_ADMIN_USER="{{ .Data.data.admin_user }}"
          export GF_SECURITY_ADMIN_PASSWORD="{{ .Data.data.admin_password }}"
          {{ end }}

      # LDAP.toml Template
      - op: add
        path: /spec/template/metadata/annotations/vault.hashicorp.com~1agent-inject-secret-ldap.toml
        value: "secret/data/grafana/ldap"
      - op: add
        path: /spec/template/metadata/annotations/vault.hashicorp.com~1agent-inject-template-ldap.toml
        value: |
          {{ with secret "secret/data/grafana/ldap" }}
          [[servers]]
          host = "{{ .Data.data.host }}"
          port = 389
          use_ssl = false
          bind_dn = "{{ .Data.data.bind_dn }}"
          bind_password = "{{ .Data.data.bind_password }}"
          search_filter = "(cn=%s)"
          search_base_dns = ["dc=example,dc=org"]

          [[servers.group_mappings]]
          group_dn = "cn=admins,dc=example,dc=org"
          org_role = "Admin"
          {{ end }}

      # D. Override Entrypoint to source the credentials
      - op: add
        path: /spec/template/spec/containers/0/command
        value: ["/bin/sh", "-c"]
      - op: add
        path: /spec/template/spec/containers/0/args
        value:
          - |
            if [ -f /vault/secrets/config.env ]; then
              source /vault/secrets/config.env
            fi
            /run.sh
