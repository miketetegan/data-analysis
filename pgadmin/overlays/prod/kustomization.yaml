apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

nameSuffix: -prod

helmCharts:
  - name: pgadmin4
    repo: https://helm.runix.net
    version: 1.49.0
    releaseName: lhw-data-analysis
    namespace: monitoring-prod
    valuesFile: values-prod.yaml

patches:
  - target:
      kind: Deployment
      name: lhw-data-analysis-pgadmin4
    patch: |
      # 1. Clear the env list to avoid "Secret not found" errors
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: PGADMIN_DEFAULT_EMAIL
            value: "chart@domain.com"

      # 2. Vault Annotations for Password AND AD Config
      - op: add
        path: /spec/template/metadata/annotations
        value:
          vault.hashicorp.com/agent-inject: "true"
          vault.hashicorp.com/role: "pgadmin-role"
          
          # Template 1: For the password (sourced in shell)
          vault.hashicorp.com/agent-inject-secret-config: "secret/data/monitoring/pgadmin"
          vault.hashicorp.com/agent-inject-template-config: |
            {{- with secret "secret/data/monitoring/pgadmin" -}}
            export PGADMIN_DEFAULT_PASSWORD="{{ .Data.data.password }}"
            {{- end -}}
          
          # Template 2: For the AD Python config file
          vault.hashicorp.com/agent-inject-secret-ad-config: "secret/data/monitoring/pgadmin"
          vault.hashicorp.com/agent-inject-template-ad-config: |
            {{- with secret "secret/data/monitoring/pgadmin" -}}
            import os
            AUTHENTICATION_SOURCES = ['ldap', 'internal']
            LDAP_SERVER_URI = 'ldap://your-ad-server-address:389'
            LDAP_BIND_USER = '{{ .Data.data.ad_bind_user }}'
            LDAP_BIND_PASSWORD = '{{ .Data.data.ad_bind_password }}'
            LDAP_BASE_DN = 'OU=Users,DC=example,DC=com'
            LDAP_USERNAME_ATTRIBUTE = 'sAMAccountName'
            LDAP_SEARCH_FILTER = '(objectclass=user)'
            # Optional: Map AD groups to pgAdmin roles
            # LDAP_AD_TEAM_AD_MAPPING = [{"team": "DB_Admins", "role": "admin"}]
            {{- end -}}

      # 3. Ensure ServiceAccount token is mounted for Vault
      - op: replace
        path: /spec/template/spec/automountServiceAccountToken
        value: true

      # 4. Updated Command to source the password and link the AD file
      - op: add
        path: /spec/template/spec/containers/0/command
        value:
          - "/bin/sh"
          - "-c"
          - |
            # Wait for both Vault files to appear
            while [ ! -f /vault/secrets/config ] || [ ! -f /vault/secrets/ad-config ]; do 
              echo 'waiting for vault...'; sleep 1; 
            done;
            
            # Source password for the initial admin account
            . /vault/secrets/config;
            
            # Link the AD Python config to the pgAdmin root directory
            ln -sf /vault/secrets/ad-config /pgadmin4/config_local.py
            
            echo "Secrets loaded and AD config linked. Starting pgAdmin..."
            exec /entrypoint.sh

  # 5. Delete the auto-generated Helm secret
  - target:
      kind: Secret
      name: lhw-data-analysis-pgadmin4
    patch: |
      $patch: delete
      apiVersion: v1
      kind: Secret
      metadata:
        name: lhw-data-analysis-pgadmin4
