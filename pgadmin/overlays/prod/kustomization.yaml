apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Keep the nameSuffix if you want the -prod name
nameSuffix: -prod
namespace: monitoring-prod

helmCharts:
  - name: pgadmin4
    repo: https://helm.runix.net
    version: 1.49.0
    releaseName: lhw-data-analysis
    namespace: monitoring-prod
    valuesFile: values-prod.yaml

patches:
  # 1. Surgical Patch for Vault and Env
  - target:
      kind: Deployment
      name: lhw-data-analysis-pgadmin4
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: lhw-data-analysis-pgadmin4
      spec:
        template:
          metadata:
            annotations:
              vault.hashicorp.com/agent-inject: "true"
              vault.hashicorp.com/role: "pgadmin-role"
              vault.hashicorp.com/agent-inject-secret-config: "secret/data/monitoring/pgadmin"
              vault.hashicorp.com/agent-inject-template-config: |
                {{- with secret "secret/data/monitoring/pgadmin" -}}
                export PGADMIN_DEFAULT_PASSWORD="{{ .Data.data.password }}"
                {{- end -}}
            # We add the env: prod label ONLY to the pod template, 
            # NOT the selector, to avoid the immutable field error.
            labels:
              env: prod
          spec:
            automountServiceAccountToken: true
            containers:
              - name: pgadmin4
                # We override the env to clear the broken secretKeyRef
                env:
                  - name: PGADMIN_DEFAULT_EMAIL
                    value: "admin@example.com"
                command:
                  - "/bin/sh"
                  - "-c"
                  - |
                    while [ ! -f /vault/secrets/config ]; do echo 'waiting for vault...'; sleep 1; done;
                    . /vault/secrets/config;
                    /entrypoint.sh

  # 2. Delete the secret as you wanted
  - target:
      kind: Secret
      name: lhw-data-analysis-pgadmin4
    patch: |
      $patch: delete
      apiVersion: v1
      kind: Secret
      metadata:
        name: lhw-data-analysis-pgadmin4
